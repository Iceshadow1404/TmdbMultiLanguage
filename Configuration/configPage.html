<div id="TmdbMultiLanguageConfigPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button">
    <div data-role="content">
        <div class="content-primary">
            <form id="tmdbMultiLanguageConfigForm">
                
                <div class="verticalSection">
                    <div class="sectionTitleContainer">
                        <h2 class="sectionTitle">TMDB Multi-Language Image Settings</h2>
                        <p class="sectionDescription">
                            Configure your API Key and preferred language order for image fetching.
                        </p>
                    </div>
                </div>

                <div class="inputContainer">
                    <label class="inputLabel inputLabelUnfocused" for="txtTmdbApiKey">TMDB API Key</label>
                    <input type="text" id="txtTmdbApiKey" name="txtTmdbApiKey" is="emby-input" required />
                    <div class="fieldDescription">Your personal API key from TheMovieDB. Required for metadata and image fetching.</div>
                </div>

                <div class="inputContainer">
                    <label class="inputLabel inputLabelUnfocused" for="txtPreferredLanguages">Preferred Languages (Comma Separated)</label>
                    <input type="text" id="txtPreferredLanguages" name="txtPreferredLanguages" is="emby-input" defaultValue="en,de,null" />
                    <div class="fieldDescription">Example: **en,de,null**. The API will search for images in this order. Using **null** instructs the API to search for images without language tags.</div>
                </div>

                <div class="inputContainer">
                    <label class="checkboxContainerLabel">
                        <input type="checkbox" id="chkEnableDebugMode" name="chkEnableDebugMode" is="emby-checkbox" />
                        <span>Enable Debug Mode</span>
                    </label>
                    <div class="fieldDescription">When enabled, detailed debug information about TMDB API interactions will be logged to the Jellyfin console. Useful for troubleshooting.</div>
                </div>

                <div>
                    <button is="emby-button" type="submit" class="raised button-submit block formDialogFooterItem">
                        <span>Save</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script type="text/javascript">
        (function() {
            'use strict';
            
            const pluginId = "96afa51e-678e-42ac-b9f6-f3679173a23f";
            let configLoaded = false;
            
            // Function to load configuration
            function loadConfig(page) {
                // Prevent multiple simultaneous loads
                if (configLoaded) {
                    return;
                }
                
                Dashboard.showLoadingMsg();
                ApiClient.getPluginConfiguration(pluginId).then(function (config) {
                    var apiKey = config.TmdbApiKey || config.tmdbApiKey || "";
                    var languages = config.PreferredLanguages || config.preferredLanguages || "en,de,null";
                    var enableDebugMode = config.EnableDebugMode || config.enableDebugMode || false;

                    var apiKeyInput = page.querySelector('#txtTmdbApiKey');
                    var languagesInput = page.querySelector('#txtPreferredLanguages');
                    var debugModeCheckbox = page.querySelector('#chkEnableDebugMode');
                    
                    if (apiKeyInput) {
                        apiKeyInput.value = apiKey;
                    }
                    
                    if (languagesInput) {
                        languagesInput.value = languages;
                    }
                    
                    if (debugModeCheckbox) {
                        debugModeCheckbox.checked = enableDebugMode;
                    }
                    
                    configLoaded = true;
                    Dashboard.hideLoadingMsg();
                }).catch(function(error) {
                    console.error("Error loading configuration:", error);
                    Dashboard.hideLoadingMsg();
                });
            }
            
            // Wait for DOM to be ready
            function init() {
                const view = document.querySelector('#TmdbMultiLanguageConfigPage');
                
                if (!view) {
                    // Retry if view not found yet (for older Jellyfin versions)
                    setTimeout(init, 100);
                    return;
                }
                
                // Multiple initialization strategies for compatibility with 10.10.7 and 10.11+
                
                // Strategy 1: viewshow event (for newer versions)
                view.addEventListener('viewshow', function () {
                    configLoaded = false;
                    loadConfig(this);
                });
                
                // Strategy 2: pageshow event (for older versions like 10.10.7)
                view.addEventListener('pageshow', function () {
                    configLoaded = false;
                    loadConfig(this);
                });
                
                // Strategy 3: Check if page is visible and load immediately
                function checkAndLoad() {
                    if (!configLoaded && view.offsetParent !== null) {
                        loadConfig(view);
                    }
                }
                
                // Try loading immediately
                setTimeout(checkAndLoad, 200);
                
                // Also try after a longer delay (for slower loading in 10.10.7)
                setTimeout(checkAndLoad, 500);
                setTimeout(checkAndLoad, 1000);
                
                // Strategy 4: MutationObserver to detect when page becomes visible
                if (typeof MutationObserver !== 'undefined') {
                    const observer = new MutationObserver(function(mutations) {
                        if (!configLoaded && view.offsetParent !== null) {
                            loadConfig(view);
                        }
                    });
                    
                    observer.observe(view, {
                        attributes: true,
                        attributeFilter: ['style', 'class'],
                        childList: false,
                        subtree: false
                    });
                }

                // Handle form submission
                const form = view.querySelector('#tmdbMultiLanguageConfigForm');
                if (form) {
                    form.addEventListener('submit', function (e) {
                        Dashboard.showLoadingMsg();
                        const formElement = this;
                        const page = formElement.closest('.pluginConfigurationPage');
                        
                        // Read values from form inputs
                        var tmdbApiKey = page.querySelector('#txtTmdbApiKey').value;
                        var preferredLanguages = page.querySelector('#txtPreferredLanguages').value;
                        var enableDebugMode = page.querySelector('#chkEnableDebugMode').checked;

                        // Load current config, merge changes, and update
                        ApiClient.getPluginConfiguration(pluginId).then(function (currentConfig) {
                            var config = currentConfig || {};
                            config.TmdbApiKey = tmdbApiKey;
                            config.PreferredLanguages = preferredLanguages;
                            config.EnableDebugMode = enableDebugMode;
                            
                            ApiClient.updatePluginConfiguration(pluginId, config).then(function (result) {
                                Dashboard.processPluginConfigurationUpdateResult(result);
                            }, function(error) {
                                console.error("Error saving configuration:", error);
                                Dashboard.alert({
                                    message: "Error saving configuration: " + (error.Message || error)
                                });
                            });
                        });
                        
                        e.preventDefault();
                        return false;
                    });
                }
            }
            
            // Initialize when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                // DOM already loaded
                init();
            }
            
            // Also try initialization after window load (for 10.10.7 compatibility)
            window.addEventListener('load', function() {
                setTimeout(init, 100);
            });
        })();
    </script>
</div>